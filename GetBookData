import sys
import time
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from webdriver_manager.chrome import ChromeDriverManager

def scrape_book_by_isbn(isbn):
    print(f"ğŸ” ISBN: {isbn}")
    search_url = f"https://www.kinokuniya.co.jp/disp/CSfDispListPage_001.jsp?qs=true&ptk=07&q={isbn}"
    options = webdriver.ChromeOptions()
    driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=options)

    try:
        driver.get(search_url)
        WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.CLASS_NAME, 'list_area_wrap')))
        print("âœ… æ¤œç´¢çµæœãƒšãƒ¼ã‚¸ã‚’é–‹ãã¾ã—ãŸ")
        item_wrap = driver.find_element(By.CLASS_NAME, 'list_area_wrap')
        products = item_wrap.find_elements(By.CLASS_NAME, 'list_area')
        if not products:
            print("âŒ å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ")
            driver.quit()
            return
        detail_link = products[0].find_element(By.CSS_SELECTOR, 'h3 a').get_attribute('href')
        print(f"ğŸ”— å•†å“è©³ç´°ãƒšãƒ¼ã‚¸ã«é·ç§»: {detail_link}")
        driver.get(detail_link)
        WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.TAG_NAME, 'h1')))
        print("âœ… å•†å“è©³ç´°ãƒšãƒ¼ã‚¸ã‚’é–‹ãã¾ã—ãŸ")
        try:
            right_box = driver.find_element(By.CLASS_NAME, "right_box")
            try:
                title = right_box.find_element(By.CSS_SELECTOR, 'h3[itemprop="name"]').text.strip()
            except:
                title = "ã‚¿ã‚¤ãƒˆãƒ«ãªã—"
            try:
                infobox = right_box.find_element(By.CLASS_NAME, "infobox")
                list_items = infobox.find_elements(By.TAG_NAME, "li")
                author = list_items[0].find_element(By.TAG_NAME, "a").text.strip() if list_items else "è‘—è€…ãªã—"
                publisher = "å‡ºç‰ˆç¤¾æƒ…å ±ãªã—"
                price = "ä¾¡æ ¼æƒ…å ±ãªã—"
                points = "ãƒã‚¤ãƒ³ãƒˆæƒ…å ±ãªã—"
                for li in list_items:
                    text = li.text.strip()
                    if "ç¤¾" in text:
                        if "ï¼ˆ" in text:
                            publisher = text.split("ï¼ˆ")[0].strip()
                        else:
                            publisher = text
                    elif "ä¾¡æ ¼" in text:
                        try:
                            price = li.find_element(By.TAG_NAME, "span").text.strip()
                        except:
                            price = text
                    elif "ãƒã‚¤ãƒ³ãƒˆ" in text:
                        try:
                            points = li.find_element(By.CLASS_NAME, "redhot").text.strip()
                        except:
                            points = text
            except:
                author = "è‘—è€…æƒ…å ±ãªã—"
                publisher = "å‡ºç‰ˆç¤¾æƒ…å ±ãªã—"
                price = "ä¾¡æ ¼æƒ…å ±ãªã—"
                points = "ãƒã‚¤ãƒ³ãƒˆæƒ…å ±ãªã—"
        except:
            title = "ã‚¿ã‚¤ãƒˆãƒ«ãªã—"
            author = "è‘—è€…æƒ…å ±ãªã—"
            publisher = "å‡ºç‰ˆç¤¾æƒ…å ±ãªã—"
            price = "ä¾¡æ ¼æƒ…å ±ãªã—"
            points = "ãƒã‚¤ãƒ³ãƒˆæƒ…å ±ãªã—"
        try:
            career_box = driver.find_element(By.CLASS_NAME, "career_box")
            h3s = career_box.find_elements(By.TAG_NAME, "h3")
            ps = career_box.find_elements(By.TAG_NAME, "p")
            pub_info = "å‡ºç‰ˆç¤¾å†…å®¹æƒ…å ±ãªã—"
            description = "å†…å®¹èª¬æ˜ãªã—"
            toc = "ç›®æ¬¡ãªã—"
            for i in range(len(h3s)):
                heading = h3s[i].text.strip()
                paragraph = ps[i].text.strip() if i < len(ps) else ""
                if heading == "å‡ºç‰ˆç¤¾å†…å®¹æƒ…å ±":
                    pub_info = paragraph
                elif heading == "å†…å®¹èª¬æ˜":
                    description = paragraph
                elif heading == "ç›®æ¬¡":
                    toc = paragraph
        except:
            pub_info = "å‡ºç‰ˆç¤¾å†…å®¹æƒ…å ±ãªã—"
            description = "å†…å®¹èª¬æ˜ãªã—"
            toc = "ç›®æ¬¡ãªã—"
        print("ğŸ“˜ ã‚¿ã‚¤ãƒˆãƒ«:", title)
        print("âœï¸ è‘—è€…:", author)
        print("ğŸ¢ å‡ºç‰ˆç¤¾:", publisher)
        print("ğŸ’´ ä¾¡æ ¼:", price)
        print("ğŸ ãƒã‚¤ãƒ³ãƒˆ:", points)
        print("ğŸ·ï¸ å‡ºç‰ˆç¤¾å†…å®¹æƒ…å ±:", pub_info)
        print("ğŸ“ å†…å®¹èª¬æ˜:", description)
        print("ğŸ“‘ ç›®æ¬¡:", toc)
    except Exception as e:
        print(f"âš ï¸ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: {e}")
    finally:
        input("â¸ï¸ Enterã§ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¾ã™...")
        driver.quit()

if __name__ == "__main__":
    DEFAULT_ISBN = "9784478026601"
    isbn = sys.argv[1] if len(sys.argv) >= 2 else DEFAULT_ISBN
    scrape_book_by_isbn(isbn)
